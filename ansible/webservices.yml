---
- name: Post-Terraform Debian 12 Initialization
  hosts: webservices
  gather_facts: false  # Crucial: Python is likely missing
  become: true

  vars_files:
    - secrets.yml

  tasks:
    - name: Wait for SSH to become available
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 300

    - name: Check if Python is installed
      ansible.builtin.raw: python3 --version
      register: python_installed
      failed_when: false
      changed_when: false

    - name: Bootstrap Python3 using raw module
      ansible.builtin.raw: |
        apt-get install -y python3 python3-apt
      changed_when: true
      when: python_installed.rc != 0

    - name: Gather facts
      ansible.builtin.setup:

    - name: Update apt cache and upgrade all system packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist

    - name: Install core utilities
      ansible.builtin.apt:
        name:
          - sudo
          - curl
          - wget
          - vim
          - htop
          - net-tools
          - ca-certificates
          - ufw
        state: present

    - name: Disable IPv6 in UFW (Fix for LXC containers)
      ansible.builtin.lineinfile:
        path: /etc/default/ufw
        regexp: '^IPV6='
        line: 'IPV6=no'

    - name: Set UFW defaults (Deny Incoming, Allow Outgoing)
      community.general.ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: incoming, policy: deny }
        - { direction: outgoing, policy: allow }

    - name: Allow SSH
      community.general.ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow AdGuard Home required ports
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: '53',   proto: 'any' }  # DNS 
        - { port: '80',   proto: 'tcp' }  # HTTP / Web Interface
        - { port: '443',  proto: 'tcp' }  # HTTPS / DNS-over-HTTPS
        - { port: '3000', proto: 'tcp' }  # AdGuard Initial Setup Port
        - { port: '853',  proto: 'tcp' }  # DNS-over-TLS

    - name: Enable UFW and start on boot
      community.general.ufw:
        state: enabled

    - name: Create admin user and add to sudoers
      ansible.builtin.user:
        name: "{{ admin_user }}"
        password: "{{ password | password_hash('sha512') }}"
        shell: /bin/bash
        groups: sudo
        append: yes
        create_home: yes

    - name: Set up SSH key for the new user
      ansible.builtin.authorized_key:
        user: "{{ admin_user }}"
        state: present
        key: "{{ admin_public_key }}"

    - name: Download and install AdGuard Home
      ansible.builtin.shell: |
        curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
      args:
        creates: /opt/AdGuardHome/AdGuardHome

    - name: Ensure AdGuard Home service is enabled and started
      ansible.builtin.service:
        name: AdGuardHome
        state: started
        enabled: yes

     ########### CADDY
    - name: Install build dependencies
      apt:
        name: [debian-keyring, debian-archive-keyring, apt-transport-https]
        state: present
        update_cache: yes

      ######### GOLANG Version 1.23
    - name: Download and Install Go 1.23.0
      shell: |
        curl -L https://go.dev/dl/go1.23.0.linux-amd64.tar.gz | tar -C /usr/local -xz
      args:
        creates: /usr/local/go/bin/go

    - name: Link Go to /usr/bin for global access
      file:
        src: /usr/local/go/bin/go
        dest: /usr/bin/go
        state: link
        force: yes

    - name: Link Gofmt to /usr/bin
      file:
        src: /usr/local/go/bin/gofmt
        dest: /usr/bin/gofmt
        state: link
        force: yes

    - name: Verify Go version
      command: go version
      register: go_version_output

    - name: Print Go version
      debug:
        msg: "Installed {{ go_version_output.stdout }}"

      ######### caddy

    - name: Add Caddy GPG key
      shell: |
        curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg

    - name: Add Caddy repository
      copy:
        dest: /etc/apt/sources.list.d/caddy-stable.list
        content: |
          deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main

    - name: Install Caddy
      apt:
        name: caddy
        state: present
        update_cache: yes

    - name: DL xcaddy
      shell: |
        curl -1sLf 'https://dl.cloudsmith.io/public/caddy/xcaddy/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-xcaddy-archive-keyring.gpg
        curl -1sLf 'https://dl.cloudsmith.io/public/caddy/xcaddy/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-xcaddy.list
        apt update && apt install xcaddy -y
      args:
        creates: /usr/bin/xcaddy

    - name: Build Caddy with Cloudflare plugin
      command: xcaddy build --with github.com/caddy-dns/cloudflare
      args:
        creates: ./caddy

    - name: Move custom Caddy to /usr/bin/
      copy:
        src: ./caddy
        dest: /usr/bin/caddy
        remote_src: yes
        mode: '0755'
      notify: Restart Caddy

    - name: Configure Caddyfile for Cloudflare
      copy:
        dest: /etc/caddy/Caddyfile
        owner: caddy
        group: caddy
        mode: '0644'
        content: |
          {
            email {{ caddy_email }}
          }

          {{ domain }}, *.{{ domain }} {
            tls {
              dns cloudflare {{ cloudflare_api_token }}
            }
            reverse_proxy {{ service_address }}
          }
      notify: Reload Caddy

  handlers:
    - name: Restart Caddy
      systemd: { name: caddy, state: restarted }
    - name: Reload Caddy
      systemd: { name: caddy, state: reloaded }

