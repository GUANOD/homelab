---
- name: Post-Terraform Debian 12 Initialization
  hosts: webservices
  gather_facts: false  # Crucial: Python is likely missing
  become: true

  vars_files:
    - vars/secrets.yml
    - vars/versions.yml
    - vars/tf_gen.yml

  vars:
    
  tasks:
    - name: Wait for SSH to become available
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 300

    - name: Check if Python is installed
      ansible.builtin.raw: python3 --version
      register: python_installed
      failed_when: false
      changed_when: false

    - name: Bootstrap Python3 using raw module
      ansible.builtin.raw: |
        apt-get install -y python3 python3-apt
      changed_when: true
      when: python_installed.rc != 0

    - name: Gather facts
      ansible.builtin.setup:

    - name: Update apt cache and upgrade all system packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist

    - name: Install core utilities
      ansible.builtin.apt:
        name:
          - sudo
          - curl
          - wget
          - vim
          - htop
          - net-tools
          - ca-certificates
          - ufw
        state: present

    - name: Disable IPv6 in UFW (Fix for LXC containers)
      ansible.builtin.lineinfile:
        path: /etc/default/ufw
        regexp: '^IPV6='
        line: 'IPV6=no'

    - name: Set UFW defaults (Deny Incoming, Allow Outgoing)
      community.general.ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: incoming, policy: deny }
        - { direction: outgoing, policy: allow }

    - name: Allow SSH
      community.general.ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow AdGuard Home required ports
      community.general.ufw:
        rule: allow

        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: '53',   proto: 'any' }  # DNS 
        - { port: '80',   proto: 'tcp' }  # HTTP / Web Interface
        - { port: '8080',   proto: 'tcp' }  # adguard config
        - { port: '443',  proto: 'tcp' }  # HTTPS / DNS-over-HTTPS
        - { port: '3000', proto: 'tcp' }  # AdGuard Initial Setup Port
        - { port: '853',  proto: 'tcp' }  # DNS-over-TLS

    - name: Enable UFW and start on boot
      community.general.ufw:
        state: enabled

    - name: Create admin user and add to sudoers
      ansible.builtin.user:
        name: "{{ admin_user }}"
        password: "{{ password | password_hash('sha512') }}"
        shell: /bin/bash
        groups: sudo
        append: yes
        create_home: yes


    - name: Set up SSH key for the new user
      ansible.builtin.authorized_key:
        user: "{{ admin_user }}"
        state: present
        key: "{{ admin_public_key }}"

    - name: Download and install AdGuard Home
      ansible.builtin.shell: |
        curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
      args:
        creates: /opt/AdGuardHome/AdGuardHome

    - name: Ensure AdGuard Home service is enabled and started
      ansible.builtin.service:
        name: AdGuardHome
        state: started
        enabled: yes

    - name: Deploy AdGuard Home configuration
      ansible.builtin.template:
        src: templates/AdGuardHome.yaml.j2
        dest: /opt/AdGuardHome/AdGuardHome.yaml
        owner: root
        group: root
        mode: '0644'
        # This backup option is a lifesaver if a template deployment fails
        backup: yes 
      notify: Restart AdGuard

     ########### CADDY
    - name: Install build dependencies
      apt:
        name: [debian-keyring, debian-archive-keyring, apt-transport-https]
        state: present
        update_cache: yes

      ######### GOLANG Version 1.23
    - name: Check installed Go version
      ansible.builtin.command: /usr/local/go/bin/go version
      register: current_go_version
      failed_when: false
      changed_when: false

    - name: Install Go {{ go_version }}
      ansible.builtin.unarchive:
        src: "https://go.dev/dl/go{{ go_version }}.linux-amd64.tar.gz"
        dest: /usr/local
        remote_src: yes
        # Only extract if the version string isn't found in the current binary
      when: current_go_version.rc != 0 or go_version not in current_go_version.stdout

    - name: Link Go binaries to /usr/bin
      ansible.builtin.file:
        src: "/usr/local/go/bin/{{ item }}"
        dest: "/usr/bin/{{ item }}"
        state: link
        force: yes
      loop: [go, gofmt]

    - name: Verify Go version
      ansible.builtin.command: go version
      register: go_version_output
      changed_when: false

    - name: Print Go version
      ansible.builtin.debug:
        msg: "Active Version: {{ go_version_output.stdout }}"

      ######### caddy

    - name: Download Caddy GPG key (Armored)
      ansible.builtin.get_url:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        dest: /tmp/caddy-stable.key
        mode: '0644'

    - name: Dearmor Caddy GPG key
      ansible.builtin.command:
        cmd: gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg /tmp/caddy-stable.key
        creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg

    - name: Clean up armored key
      ansible.builtin.file:
        path: /tmp/caddy-stable.key
        state: absent

    - name: Add Caddy repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
        state: present
        filename: caddy-stable

    - name: Install Caddy
      apt:
        name: caddy
        state: present
        update_cache: yes

    - name: Check current Caddy modules
      ansible.builtin.command: /usr/bin/caddy list-modules
      register: caddy_modules
      check_mode: false
      failed_when: false
      changed_when: false

    - name: Build and deploy custom Caddy
      block:
        - name: Download xcaddy GPG key
          ansible.builtin.get_url:
            url: https://dl.cloudsmith.io/public/caddy/xcaddy/gpg.key
            dest: /tmp/xcaddy.key
            mode: '0644'

        - name: Dearmor xcaddy GPG key
          ansible.builtin.command:
            cmd: gpg --dearmor -o /usr/share/keyrings/caddy-xcaddy-archive-keyring.gpg /tmp/xcaddy.key
            creates: /usr/share/keyrings/caddy-xcaddy-archive-keyring.gpg

        - name: Add xcaddy APT repository
          ansible.builtin.apt_repository:
            repo: "deb [signed-by=/usr/share/keyrings/caddy-xcaddy-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/xcaddy/deb/debian any-version main"
            state: present
            filename: caddy-xcaddy

        - name: Install xcaddy package
          ansible.builtin.apt:
            name: xcaddy
            state: present
            update_cache: yes

        - name: Build Caddy with Cloudflare plugin
          ansible.builtin.command:
            cmd: xcaddy build --with github.com/caddy-dns/cloudflare
            chdir: /tmp

        - name: Move custom Caddy to /usr/bin/
          ansible.builtin.copy:
            src: /tmp/caddy
            dest: /usr/bin/caddy
            remote_src: yes
            owner: root
            group: root
            mode: '0755'
          notify: Restart Caddy

        - name: Prevent apt from overwriting custom Caddy
          ansible.builtin.dpkg_selections:
            name: caddy
            selection: hold

        - name: Cleanup build artifact
          ansible.builtin.file:
            path: /tmp/caddy
            state: absent
      when: caddy_modules.rc != 0 or "dns.providers.cloudflare" not in caddy_modules.stdout

    - name: Deploy Caddy Configuration
      ansible.builtin.template:
        src: templates/Caddyfile.j2
        dest: /etc/caddy/Caddyfile
        owner: caddy
        group: caddy
        mode: '0644'
      notify: Reload Caddy

  handlers:
    - name: Restart Caddy
      systemd: { name: caddy, state: restarted }
    - name: Reload Caddy
      systemd: { name: caddy, state: reloaded }
    - name : Restart AdGuard
      systemd: { name: AdGuardHome, state: restarted}

